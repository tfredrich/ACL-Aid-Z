@startuml
class AccessControl {
  -objects : Map<String, ObjectDefinition>
  -tuples : TupleStore
  +check(userset:String, relation:String, objectId:String) : boolean
}
class ObjectDefinition {
  -name : String
  -relations : Map<String, RelationDefinition>
  +rewrite(objectId : String) : UserSetExpression
}
class RelationDefinition {
  -name : String
  -parent : ObjectDefinition
  +rewrite(objectId:ObjectId) : UserSetExpression
}
interface RewriteRule {
  +rewrite(objectId : ObjectId) : UserSetExpression
  +isLeaf() : false
}
interface RewriteRuleLeaf {
  +isLeaf() : true
}
abstract BinaryRewriteRule {
  -lRule : RewriteRule
  -rRule : RewriteRule
}
class This
class ComputedUserSet {
  -relation : RelationDefinition
}
class SimpleTupleStore {
 -tuples : Collection<Tuple>
}
interface TupleStore {
  +check(userset: UserSet, relation: String, objectId: ObjectId): boolean
  +read(filter : TupleSet): Collection<Tuple>
  +readOne(userset: UserSet, relation: String, objectId: ObjectId): Tuple
  +remove(tuple : Tuple): TupleStore
  +write(tuple : Tuple): TupleStore
}
class TupleToUserSet {
  -userset : ComputedUserSet
  -selector : Tuple
}
enum Tuple {
  $TUPLE_USERSET_OBJECT
  $TUPLE_USERSET_RELATION
  $TUPLE_RELATION
}

interface UserSetExpression {
  +evaluate(tuples: TupleStore, userset: UserSet): boolean
}
class ComputedUserSetExpression {
}
class ThisExpression {
}
class TupleToUserSetExpression {
}
class UnionExpression {
  -children: List<UserSetExpression>
}
abstract BinaryUserSetExpression {
  -lValue: UserSetExpression
  -rValue: UserSetExpression
}
class IntersectionExpression {
}
class ExclusionExpression {
}

AccessControl --> TupleStore
AccessControl "1" *-->  "*" ObjectDefinition

RewriteRule <|.. BinaryRewriteRule
RewriteRule <|.. RewriteRuleLeaf
RewriteRule <|.. Union

BinaryRewriteRule <|-- Intersection
BinaryRewriteRule <|-- Exclusion
BinaryRewriteRule --> RewriteRule: lRule
BinaryRewriteRule --> RewriteRule: rRule

RewriteRuleLeaf <|.. This
RewriteRuleLeaf <|.. ComputedUserSet
RewriteRuleLeaf <|.. TupleToUserSet

ObjectDefinition "1" *-- "*" RelationDefinition : contains
ObjectDefinition --> UserSetExpression: produces
RelationDefinition "0" --> "1" RewriteRule: has
Union "1" --> "*" RewriteRuleLeaf

UserSetExpression <|.. UnionExpression
UserSetExpression <|.. ThisExpression
UserSetExpression <|.. TupleToUserSetExpression
UserSetExpression <|.. ComputedUserSetExpression
UserSetExpression <|.. BinaryUserSetExpression
BinaryUserSetExpression <|-- IntersectionExpression
BinaryUserSetExpression <|-- ExclusionExpression
TupleToUserSetExpression --> "1" ComputedUserSetExpression
UnionExpression --> "*" UserSetExpression
BinaryUserSetExpression --> UserSetExpression: lValue
BinaryUserSetExpression --> UserSetExpression: rValue

TupleStore <|.. SimpleTupleStore

TupleToUserSet --> ComputedUserSet
TupleToUserSet --> Tuple
ComputedUserSet --> RelationDefinition: relation
@enduml